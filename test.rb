require 'openai'

  begin
    puts "Calling OpenAI API for risk assessment..." # デバッグ用ログ
    @client = OpenAI::Client.new(access_token: 'sk-None-J96fOoSLvQvSNkAMjetIT3BlbkFJGOV0JSM57SoYRiM47c6w')
    response = @client.chat(
        parameters: {
        model: 'gpt-3.5-turbo',
        temperature: 0, 
        messages: [
          { role: 'system', content: 'あなたは優秀なAIアシスタントです。' },
          { role: 'user', content: "
          #要件
            - 以後の会話では、あなたはニュース記事のリスク判定BOTとして振る舞います
            - リスクは被害範囲・被害程度・社会的影響・死傷者・被害金額の５つの項目でそれぞれ0から20の20段階で評価されます。リスクはその５つの項目の評価の合計となります。
            - 値が高いほどリスクが高いです。

          #考え方
            ニュース記事から被害程度・被害程度・社会的影響・死傷者・被害金額にかかわる内容を抽出・判断。次のような観点で評価する。
              被害範囲:物理的な被害範囲を考える。市町村の範囲であれば10、世界規模の被害範囲であれば20とする。
              被害程度:具体的な被害内容を考える 。2001年のアメリカ同時多発テロ事件のレベルを20とする。
              社会的影響:当該ニュース記事によってどのくらい社会的影響がでるかを評価する。コロナなど、長期間・大規模で影響が出るものを20とする。
              死傷者:死亡者、負傷者や負傷の程度を考える。死亡者や負傷者がいなければ0、死亡者や負傷者が数百人～数千人規模の事件は20とする。
              被害金額:被害金額が0円であれば0、数兆円規模の被害金額であれば20とする。

          ## 出力形式
            データは次の形式で返してください。
            
            リスクスコア:{(リスクスコア)}
            
          #例
            例えば、被害範囲の判定が10、被害程度の判定が8、社会的影響の判定が18、死傷者の判定が4、被害金額の判定が20だったら、リスクスコア=10+8+18+4+20=60となり出力は次のようになります

            リスクスコア:{60}

          それでは、以下の記事のリスクを1から100で評価してください。：\n\n28日、福岡県柳川市の農地に民間のヘリコプターが墜落し2人が死亡した事故で、国の運輸安全委員会の航空事故調査官が現地に派遣され、調査を始めました。一方、事故機が墜落前に行っていた会社や佐賀空港との無線交信で異常は報告されず、最終進入経路に到達したあとに墜落したとみられることが、会社への取材で新たにわかりました。 警察などによりますと、28日午後4時12分ごろ、柳川市昭南町の農地で、遊覧飛行などを行っている佐賀市の会社のヘリコプターが墜落し、現場で2人が遺体で見つかりました。 会社によりますと、ヘリコプターには ▽50歳の男性パイロット ▽70歳の男性整備士 が乗っていて、大分県日田市から佐賀空港に戻る途中だったということで、警察が亡くなったのはこの2人とみて身元の確認を進めています。 国の運輸安全委員会は29日午後、航空事故調査官2人を現地に派遣して調査を始めました。 事故機が墜落前に行っていた無線交信で異常は報告されず、最終進入経路に到達したあとに、墜落したとみられることが新たにわかりました。 会社や国土交通省大阪航空局によりますと、事故機は墜落およそ4分前の午後4時8分ごろ、社内無線で佐賀空港への到着予定時間を連絡していたほか、佐賀空港の運航情報官に対し、午後4時9分ごろ空港の東南東およそ13キロを飛行中だと伝え、墜落およそ1分前の午後4時11分ごろには空港まで5キロあまりの最終進入経路に到達したことを伝えていたということで、いずれの交信でも異常の報告はなかったということです。 運輸安全委員会は、こうした交信の内容についても関係者から聞き取りを行うなどして、事故原因を詳しく調べることにしています。 運航会社「事故調査に全面的に協力」 墜落したヘリコプターを運航していた佐賀市の「エス・ジー・シー佐賀航空」は29日コメントを発表し、「住民や関係機関の皆様に多大なるご迷惑とご心配をおかけしていることを、深くおわび申し上げます」としています。 そのうえで「事故原因については現在調査中であり、特定に至っていませんが、事故調査に全面的に協力するとともに、二度とこのような悲しい事故が起こることがないよう、社員一丸となって取り組んでいきたいと考えています」などとしています。" }
        ],
      }
    )

    puts "API response: #{response.inspect}" # レスポンス全体を出力

    if response && response['choices'] && response['choices'][0] && response['choices'][0]['message'] && response['choices'][0]['message']['content']
      content = response['choices'][0]['message']['content'].strip
      puts "Raw content received: #{content}" # 受信した内容の生データを出力

      # リスクスコアの行を抽出
      if match = content.match(/リスクスコア:(\d+)/)
        risk_score = match[1].to_i
        puts "Extracted risk score: #{risk_score}" # 抽出されたリスクスコアを出力
        risk_score
      else
        puts "Risk score not found in the content"
        nil
      end
    else
      puts "Invalid response format"
      nil
    end
  rescue StandardError => e
    puts "Error assessing risk: #{e.message}"
    nil
  end